# 中长期架构治理思路（草案）

> 目标：给未来的“架构治理迭代”提供一个可执行的蓝本，而不是一次性大重构。本文只做思路设计，不要求立刻实施。

---

## 1. 当前基础与约束

### 1.1 已有基础

- 工具与规则：
  - Lefthook pre-commit / pre-push（arch-check、circular-check、quality-gate、security-check 等）。
  - dependency-cruiser（enforce-domain-boundaries、循环依赖检测）。
  - Vitest + coverage 路线图（42.92% → 65% → 75% → 80%）。
- 文档与规范：
  - `AGENTS.md`：全局编码规范 + 面向智能代理规则。
  - `docs/technical-doc/*`：质量保障、技术栈说明等。

### 1.2 前置约束

- 不做“推倒重来式重构”，以**小步迭代**为主。
- 任何“收紧规则”必须先有配套的**灰度期**和**降级方案**，避免直接阻塞日常开发。

---

## 2. 整体治理思路概览

从“配置层”和“代码层”两个维度分步收紧：

1. **配置层收紧 / 分类**（规则系统）：
   - 把“质量红线”固化在工具和配置里（Lefthook、ESLint、dependency-cruiser 等）。
   - 区分不同目录/域的规则强度（如核心域更严格、外围域更宽松）。
   - 让规则可观测、可调节，而不是一次性锁死。

2. **代码层收紧 / 分层**（结构系统）：
   - 明确“域 / 层”的边界（如 web-vitals、content/i18n、UI 层、infra 工具等）。
   - 用 dependency-cruiser + 目录结构约束依赖方向，减少跨域耦合。
   - 以“域”为单位做重构，而不是散点修补。

中长期节奏建议对应现有质量阶段：

- Phase 1：质量基线巩固（3 个月，覆盖率 ≥ 65%）。
- Phase 2：架构边界清理（6 个月，主要针对跨域依赖）。
- Phase 3：局部域重构与能力下沉（12 个月及以后）。

---

## 3. 配置层收紧的具体方向

### 3.1 arch-check / dependency-cruiser

**目标**：从“信息展示”演进到“部分域的硬约束”。

建议步骤：

1. **建立基线**：
   - 记录当前 `enforce-domain-boundaries` 输出（约 70 条跨域依赖）作为基准快照。
   - 将快照结果归档到 `docs/analysis-report/`（例如按域分类列出）。

2. **先做“白名单域”治理**：
   - 选 1–2 个关键域作为试点（例如：`src/lib/web-vitals`、content/i18n 相关 lib）。
   - 为这些域定义“明确允许的依赖方向”（例如：
     - `web-vitals` 只能依赖 `lib/*` 和 `config/*`，禁止直接依赖 `components/*`。
   - 在 dependency-cruiser 配置中对试点域启用 **warning 级别** 规则。

3. **逐步升级严重级别**：
   - 当试点域的 warning 降到可接受范围（例如 < 5 条）后：
     - 将跨域依赖从 warning 升级为 error；
     - 或者只对“新增/修改文件”启用 error（通过规则 + git diff 控制）。

4. **扩展到更多域**：
   - 按优先级：核心业务域 > 公共 lib > UI 组件。
   - 每次扩展都要复用“基线记录 → 试点 → 灰度收紧”这个流程。

### 3.2 quality-gate / 覆盖率

**目标**：让覆盖率提升“自然发生”，而不是一次性硬卡所有变更。

建议步骤：

1. **新增代码强制带测试**：
   - 针对特定目录（如 `src/lib/*`、核心业务域），在 quality-gate 中增加规则：
     - 若某 PR 在这些目录新增文件且无对应 `__tests__` / `tests` 覆盖，则给出 warning。
   - 先从 warning 开始，观察 1–2 个月对开发节奏的影响。

2. **增量覆盖率守卫**：
   - 基于现有覆盖率基线，增加“**不允许当前变更引入明显覆盖率下降**”的规则（例如 diff-based coverage）。
   - 对单个 PR：覆盖率下降超出阈值（例如 1–2%）时给出 warning 或软失败。

3. **阶段性提升全局阈值**：
   - 当实际覆盖率长期稳定高于某一档（例如稳定 > 60%），再将 quality-gate 的最低阈值提升到 60%。
   - 保持“阈值 < 实际值”的缓冲区，避免频繁阻塞。

### 3.3 规则分层（按目录/域配置 ESLint / 安全规则）

**目标**：在不增加噪音的前提下，加大核心域的规则力度。

示例：

- 对 `src/lib/security/*`、`src/lib/content-parser.ts` 等与安全/解析相关的模块：
  - 启用更严格的安全规则（路径遍历、防注入、输入校验）。
  - 禁止 `any`、禁止未处理异常。
- 对 `tests/**`：
  - 放宽部分复杂度限制（已在 AGENTS 中定义），但继续禁止 `jest.*` API。

---

## 4. 代码层收紧 / 分层的具体方向

### 4.1 域划分建议（草案）

不要求一次性重构，只做“下一步变更的参考方向”：

- **Core Lib / Infra 层**：
  - 例如：`src/lib/content-parser.ts`、`src/lib/logger.ts`、`src/lib/web-vitals/*`。
  - 主要职责：通用能力、跨业务复用的工具。
- **Domain Lib 层**：
  - 例如：围绕“内容与 i18n”的模块、“性能监控”相关模块。
  - 主要职责：针对具体业务域的封装（如 frontmatter 解析、web-vitals 聚合）。
- **UI / Page 层**：
  - `src/components/**`、`src/app/**` 等。
  - 主要职责：组合数据和组件，尽量不承载复杂业务逻辑。

### 4.2 依赖方向原则

- UI / Page 层可以依赖 Domain Lib + Core Lib。
- Domain Lib 可以依赖 Core Lib，但尽量不反向依赖 UI。
- Core Lib 禁止依赖 UI / Page 层。

这部分可以在未来通过 dependency-cruiser 的 `forbidden` 规则逐步编码成工具约束。

### 4.3 渐进式分层重构策略

1. **新代码遵守，新旧并存一段时间**：
   - 对新建模块（尤其是 lib 层）强制按照上述依赖方向和目录结构组织。
   - 旧模块不强制迁移，但在触碰时遵守新规则（“Boy Scout” 策略）。

2. **按域做“机会式重构”**：
   - 每当对某个域做功能迭代时，同步清理该域内部的：
     - 跨域依赖；
     - 过度耦合 UI / lib 的地方；
     - 重复逻辑和工具函数。

3. **通过测试与监控兜底**：
   - 在分层重构前，优先补上该域的关键路径测试（单测 + 集成测试）。
   - 利用现有 web-vitals / 性能监控，观察重构前后指标。

---

## 5. 度量与里程碑

为避免“重构无终点”，建议为架构治理设置可度量的目标：

- Arch 相关：
  - `enforce-domain-boundaries` 报告的违规数量（按季度统计）。
  - 循环依赖数量（目标维持为 0）。
- 质量相关：
  - 全局测试覆盖率（按路线图推进）。
  - 核心域覆盖率（可以高于全局平均）。
- 安全相关：
  - security-check 报告的高危/中危数量。
  - 安全相关模块中通过静态分析的比例。

每到一个阶段（如覆盖率达到新台阶、arch violation 明显下降）时，可以在 `docs/analysis-report/` 下补一份简短总结，对比“计划与实际”。

---

## 6. 后续使用方式

- 本文作为“中长期架构治理思路草案”，暂不要求立刻落地。
- 未来若需要启动治理：
  1. 先选一个小域做试点（例如 web-vitals 或 content-parser 相关域）。
  2. 从“配置层收紧”开始（arch-check 规则 + quality-gate 调整）。
  3. 再在该域内做有限度的分层重构。
- 任意阶段如果实践与本文有偏差，可以直接在本文件下追加“修订记录”段落，而不是另起一份文档。
