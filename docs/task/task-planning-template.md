# 任务规划文档模板

> 用途：为中大型任务（P1/P2/P3 等）提供统一规划格式，兼容「codex规划 → Claude Code 实现 →codex 审查」的工作流。
>
> 使用方式：新任务时复制本文件内容到 `docs/task/pX-Y-任务名-plan.md`，根据注释填写。

---

## 1. 任务总览（Overview）

- **任务编号 & 标题**：
  - 示例：P2-1：Lighthouse 阈值收紧 & 性能优化节奏
- **业务背景（为什么要做）**：
  - 说明这件事解决什么业务/产品问题，例如：
  - 例：Lighthouse Performance 目前门槛较宽，无法有效约束后续开发导致性能回退。
- **技术背景（在什么环境里做）**：
  - 说明当前相关技术栈 / 架构 / 已有能力，例如：
  - 例：Next.js 16 + React 19 + TS 严格模式，已有 Lighthouse CI 性能 job、MDX 内容系统等。
- **最终目标（可量化）**：
  - 用一两句明确写出「完成后必须达到的指标」，例如：
  - Performance ≥ 0.9；total-byte-weight ≤ 480KB；TS/Lint/Test/Build/Perf 全绿。

---

## 2. 当前状态（Current State）

- **代码结构 & 相关文件**：
  - 列出与本任务直接相关的目录和文件（只列关键路径）：
  - 例如：配置文件、脚本、核心模块、CI workflow、测试文件等。
- **现有指标 / 行为**：
  - 用真实数据说明当前表现（可以来自 CI 报表、本地命令）：
  - 例：`/` 页面当前 Lighthouse Performance = 0.83，LCP ≈ 3.8s，total-byte-weight ≈ 610KB。
- **已有约束与规则**：
  - 引用 `.augment/rules/*.md`、`agent_docs/*` 中与本任务直接相关的约束：
  - 例：TS 严格模式、复杂度预算、i18n 规则、Cache Components、RSC/Client 边界等。

---

## 3. 目标状态 & 非目标（Target & Non-goals）

- **目标状态（要达到什么）**：
  - 从代码能力和质量指标两个角度描述：
  - 例：
    - 代码：新增一个 MDX slug 校验 CLI，接入 Lefthook 和 CI；
    - 质量：CI 中 translation job 如有 slug 不对齐则 fail。
- **非目标（本阶段刻意不做什么）**：
  - 明确列出当前任务「不会修改」的范围，避免误伤：
  - 例：不重构 i18n routing、不调整 messages 结构、不修改支付逻辑等。

---

## 4. 阶段划分 / 路线图（Phases / Roadmap）

> 建议至少拆成 2–3 个 Phase，每个 Phase 都有清晰目标与完成标志。

- **Phase 1：**
  - 目标：
  - 主要动作：
  - 完成标志：
- **Phase 2：**
  - 目标：
  - 主要动作：
  - 完成标志：
- **Phase 3（可选）：**
  - 目标：
  - 主要动作：
  - 完成标志：

---

## 5. 任务拆解（Task Breakdown）

> 将任务拆成若干 Task A/B/C…，单个任务应在 0.5–2 个工作日内可完成。

### Task A：任务名称（一句话）

- **任务目标**：
  - 这一小步完成后，独立能带来的价值是什么？
- **输入 / 前置条件**：
  - 需要哪些已有脚本/配置/数据？
  - 是否依赖 Task X 先完成？
- **主要步骤（面向执行者的 checklist）**：
  - 第 1 步：
  - 第 2 步：
  - ……
- **预期输出**：
  - 新增/修改的文件、脚本、接口、文档等。
- **验收标准**：
  - 至少要满足哪些条件才算「Task A 完成」。

> 按需追加 Task B / Task C / …，结构保持一致。

---

## 6. 技术实施细节（Implementation Details）

> 这一节偏工程落地，给人类开发者和 Claude Code 看的「怎么改代码」。

- **文件级改动清单**：
  - 列出可能被修改/新增的文件路径及大致改动内容。
- **接口 / 类型 / 数据结构要求**：
  - 明确函数签名、TS 接口、输入/输出形态；必要时用伪代码描述。
- **架构 & 风格约束**：
  - 例如：
    - 保持 RSC 与 Client Component 边界；
    - 不新增 `any`；
    - 不引入新的全局单例；
    - 遵守 i18n、日志、安全相关规范等。

---

## 7. 质量与验证策略（Quality & Verification）

- **需要运行的命令**：
  - 至少包括：
    - `pnpm type-check`
    - `pnpm lint:check`
    - `pnpm test`
    - 以及与本任务相关的额外命令，例如：`pnpm perf:lighthouse`、自定义脚本等。
- **验收指标**：
  - 写清需要关注的数值/行为：
  - 例：Performance ≥ X；bundle 体积 ≤ Y；无 ESLint error/warn 等。
- **测试要求**：
  - 新增/修改哪些测试文件（单测 / 集成测）；
  - 至少覆盖哪些核心场景与错误路径。

---

## 8. 风险、回滚与注意事项（Risks & Rollback）

- **风险清单**：
  - 列出可能影响 SEO、CLS、i18n、兼容性、安全性的点。
- **回滚策略**：
  - 哪几个文件改动是「关键切换点」，通过 `git revert` 或还原这些改动即可回滚。
- **注意事项**：
  - 禁止绕过 Lefthook / CI（不要使用 `--no-verify`）；
  - 某些 job 不能随意从硬门禁改为软门禁等。

---

## 9. 协作与交接说明（For Developers & AI）

### 9.1 给人类开发者的说明

- 建议执行顺序（先做哪些 Task，再做哪些）。
- 在哪里记录进度和变更（例如在本文件末尾追加 Changelog）。
- 哪些改动需要你本人或资深工程师额外 review。

### 9.2 给 AI Agent / Claude Code 的执行指引

> 这里可以写一段方便复制给 Claude Code 的说明文本。

- 在开始实现前，**必须先阅读**：
  - 本规划文档；
  - 相关技术规则文档（如 `.augment/rules/*.md`、`agent_docs/*`）。
- 允许改动的文件范围：
  - 明确列出可以修改/新增的文件列表或目录；
  - 明确哪些模块/文件本任务禁止触碰。
- 必须执行的命令：
  - 列出实现完成后，AI 需要在本地或 CI 中确保通过的命令。
- 交付物检查清单：
  - 代码改动；
  - 新/改动的测试；
  - 更新的文档（包括本规划文件的 Changelog）。

