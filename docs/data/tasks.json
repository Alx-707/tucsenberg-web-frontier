{
  "tasks": [
    {
      "id": "b4f3c710-3a72-4c3b-8571-4c487ec48215",
      "name": "建立 Contact Form 配置模块（类型/默认值/Zod/Builder）",
      "description": "新增 src/config/contact-form-config.ts，定义字段集合、特性与校验配置；提供 CONTACT_FORM_CONFIG 默认值、contactFormConfigSchema、createContactFormSchemaFromConfig（动态 Zod 组合）、buildFormFieldsFromConfig（将配置映射为 UI 字段描述）。默认配置严格对齐现有必填与顺序。",
      "notes": "保持默认行为与现状一致；配置支持未来 schemaVersion 迁移。",
      "status": "COMPLETE",
      "dependencies": [],
      "createdAt": "2025-11-12T09:12:01.205Z",
      "updatedAt": "2025-11-12T14:21:21.832699Z",
      "relatedFiles": [
        {
          "path": "src/config/contact-form-config.ts",
          "type": "CREATE",
          "description": "新建配置模块"
        },
        {
          "path": "src/lib/validations.ts",
          "type": "REFERENCE",
          "description": "复用既有常量与 helpers"
        },
        {
          "path": "src/app/actions.ts",
          "type": "REFERENCE",
          "description": "后续接入动态 Schema"
        }
      ],
      "implementationGuide": "pseudocode:\n- 定义 FieldKey 集合: firstName, lastName, email, company, message, phone, subject, acceptPrivacy, marketingConsent, website\n- 定义 FieldConfig: enabled, required, order, type(text/email/tel/textarea), i18nKey\n- 定义 Features: enableTurnstile, showPrivacyCheckbox, showMarketingConsent\n- 定义 Validation: emailDomainWhitelist, messageMinLength, messageMaxLength\n- 导出 CONTACT_FORM_CONFIG 与 contactFormConfigSchema\n- 导出 createContactFormSchemaFromConfig(cfg) 与 buildFormFieldsFromConfig(cfg)",
      "verificationCriteria": "存在 CONTACT_FORM_CONFIG 与 Zod schema；默认配置与现状等价；builder 函数可按配置生成字段描述与 Schema。",
      "analysisResult": "以配置优先贯穿 UI 与服务端：新增联系表单配置模块（类型、默认值、Zod 配置校验与动态 Schema 生成器），让基础必填字段可配置，同时维持现有 ContactFormContainer 与服务端处理链。扩展 FEATURE_FLAGS 启用 WhatsApp 聊天入口（懒加载 UI），并提供轻量主题配置（CSS 变量注入）。所有变更保持默认配置与现状一致，并补齐关键测试与文档。"
    },
    {
      "id": "43de8078-02fe-470b-9f7c-7466157c3ff4",
      "name": "抽取字段校验器与动态 Schema 生成器",
      "description": "在 src/lib/form-schema/ 下新增 contact-field-validators.ts 与 contact-form-schema.ts，将 validations 细化为字段级 validator，并暴露 createContactFormSchemaFromConfig 供服务端与 UI 共享。",
      "notes": "不大改 validations.ts，新增 builder 层保持兼容。",
      "status": "COMPLETE",
      "dependencies": [
        {
          "taskId": "b4f3c710-3a72-4c3b-8571-4c487ec48215"
        }
      ],
      "createdAt": "2025-11-12T09:12:01.205Z",
      "updatedAt": "2025-11-12T14:25:04.668047Z",
      "relatedFiles": [
        {
          "path": "src/lib/form-schema/contact-field-validators.ts",
          "type": "CREATE",
          "description": "字段级 Zod 规则"
        },
        {
          "path": "src/lib/form-schema/contact-form-schema.ts",
          "type": "CREATE",
          "description": "动态 Schema 生成器"
        },
        {
          "path": "src/lib/validations.ts",
          "type": "REFERENCE",
          "description": "常量与辅助函数复用"
        }
      ],
      "implementationGuide": "pseudocode:\n- contact-field-validators.ts: 导出 firstName(), lastName(), email(), company(), message(), phone(opt), subject(opt), acceptPrivacy(), marketingConsent(opt), website(honeypot)\n- 可注入 email 域白名单 refine\n- contact-form-schema.ts: 依据配置组装 z.object 动态结构",
      "verificationCriteria": "可独立从配置生成 Zod schema；email 域白名单可注入；默认生成行为与现状一致；含单元测试。",
      "analysisResult": "以配置优先贯穿 UI 与服务端：新增联系表单配置模块（类型、默认值、Zod 配置校验与动态 Schema 生成器），让基础必填字段可配置，同时维持现有 ContactFormContainer 与服务端处理链。扩展 FEATURE_FLAGS 启用 WhatsApp 聊天入口（懒加载 UI），并提供轻量主题配置（CSS 变量注入）。所有变更保持默认配置与现状一致，并补齐关键测试与文档。"
    },
    {
      "id": "9e8c94a7-6ed7-43e3-abf3-5a9a6dab4d60",
      "name": "UI：ContactFormContainer 接入配置（enabled/required/order）",
      "description": "在不破坏既有结构的前提下，依据配置控制字段渲染、required 属性与星号显示；保持 Turnstile 与速率限制逻辑不变。必要时在 FormFields 按配置重排。",
      "notes": "第一阶段不切换至 React19FormTemplate，降低风险。",
      "status": "COMPLETE",
      "dependencies": [
        {
          "taskId": "b4f3c710-3a72-4c3b-8571-4c487ec48215"
        }
      ],
      "createdAt": "2025-11-12T09:12:01.205Z",
      "updatedAt": "2025-11-12T14:29:53.261239Z",
      "relatedFiles": [
        {
          "path": "src/components/forms/contact-form-container.tsx",
          "type": "TO_MODIFY",
          "description": "注入配置驱动渲染"
        },
        {
          "path": "src/components/forms/fields/contact-fields.tsx",
          "type": "REFERENCE",
          "description": "字段组件保留"
        },
        {
          "path": "src/components/forms/fields/name-fields.tsx",
          "type": "REFERENCE",
          "description": "字段组件保留"
        },
        {
          "path": "src/components/forms/fields/message-field.tsx",
          "type": "REFERENCE",
          "description": "字段组件保留"
        },
        {
          "path": "src/components/forms/fields/checkbox-fields.tsx",
          "type": "REFERENCE",
          "description": "字段组件保留"
        }
      ],
      "implementationGuide": "pseudocode:\n- import CONTACT_FORM_CONFIG\n- const uiFields = buildFormFieldsFromConfig(CONTACT_FORM_CONFIG)\n- 过滤 disabled 字段；按 order 排序；为 required 字段设置 required 与星号\n- showPrivacyCheckbox=false 则不渲染隐私复选框",
      "verificationCriteria": "关闭某字段 enabled 后 UI 不渲染；required 切换影响 required 属性与星号；默认配置下渲染结果与现状一致。",
      "analysisResult": "以配置优先贯穿 UI 与服务端：新增联系表单配置模块（类型、默认值、Zod 配置校验与动态 Schema 生成器），让基础必填字段可配置，同时维持现有 ContactFormContainer 与服务端处理链。扩展 FEATURE_FLAGS 启用 WhatsApp 聊天入口（懒加载 UI），并提供轻量主题配置（CSS 变量注入）。所有变更保持默认配置与现状一致，并补齐关键测试与文档。"
    },
    {
      "id": "4c0218e5-4843-4e0a-8977-f4155dabe1d6",
      "name": "服务端：Actions 与 API 使用动态 Schema",
      "description": "在 actions.ts 与 contact-api-validation.ts 将静态 contactFormSchema 替换为动态 Schema，并增加邮箱域白名单错误键映射（errors.email.domainNotAllowed）。",
      "notes": "确保默认配置下行为完全一致。",
      "status": "COMPLETE",
      "dependencies": [
        {
          "taskId": "43de8078-02fe-470b-9f7c-7466157c3ff4"
        }
      ],
      "createdAt": "2025-11-12T09:12:01.205Z",
      "updatedAt": "2025-11-12T14:33:57.071033Z",
      "relatedFiles": [
        {
          "path": "src/app/actions.ts",
          "type": "TO_MODIFY",
          "description": "替换 Schema 来源并补充错误键映射"
        },
        {
          "path": "src/app/api/contact/contact-api-validation.ts",
          "type": "TO_MODIFY",
          "description": "替换 Schema 来源并补充错误键映射"
        }
      ],
      "implementationGuide": "pseudocode:\n- import CONTACT_FORM_CONFIG 与 createContactFormSchemaFromConfig\n- const schema = createContactFormSchemaFromConfig(CONTACT_FORM_CONFIG)\n- 使用 schema.safeParse(data)\n- 对域白名单失败映射到 errors.email.domainNotAllowed\n- 保持 Turnstile/重放保护/Resend/Airtable/日志不变",
      "verificationCriteria": "默认配置下现有用例全部通过；修改配置后 Server Action 与 API 校验一致；域白名单错误返回 errors.email.domainNotAllowed。",
      "analysisResult": "以配置优先贯穿 UI 与服务端：新增联系表单配置模块（类型、默认值、Zod 配置校验与动态 Schema 生成器），让基础必填字段可配置，同时维持现有 ContactFormContainer 与服务端处理链。扩展 FEATURE_FLAGS 启用 WhatsApp 聊天入口（懒加载 UI），并提供轻量主题配置（CSS 变量注入）。所有变更保持默认配置与现状一致，并补齐关键测试与文档。"
    },
    {
      "id": "7130a40c-e626-4314-a965-c760d6cde23e",
      "name": "扩展 FeatureFlags 与站点配置（WhatsApp）",
      "description": "扩展 src/config/app.ts FEATURE_FLAGS 增加 ENABLE_WHATSAPP_CHAT；在 site-config.ts 增加 contact.whatsappNumber（或 social.whatsapp）。",
      "notes": "为 UI 按钮与后续集成提供统一来源。",
      "status": "COMPLETE",
      "dependencies": [],
      "createdAt": "2025-11-12T09:12:01.205Z",
      "updatedAt": "2025-11-12T14:38:36.149873Z",
      "relatedFiles": [
        {
          "path": "src/config/app.ts",
          "type": "TO_MODIFY",
          "description": "增加 ENABLE_WHATSAPP_CHAT"
        },
        {
          "path": "src/config/paths/site-config.ts",
          "type": "TO_MODIFY",
          "description": "增加 whatsappNumber"
        }
      ],
      "implementationGuide": "pseudocode:\n- FEATURE_FLAGS: ENABLE_WHATSAPP_CHAT: env.ENABLE_WHATSAPP_CHAT ?? true\n- SITE_CONFIG.contact.whatsappNumber?: string\n- 导出类型更新，并为空值提供容错",
      "verificationCriteria": "环境变量可开启或关闭聊天入口；SITE_CONFIG 存在 WhatsApp 号码并类型正确。",
      "analysisResult": "以配置优先贯穿 UI 与服务端：新增联系表单配置模块（类型、默认值、Zod 配置校验与动态 Schema 生成器），让基础必填字段可配置，同时维持现有 ContactFormContainer 与服务端处理链。扩展 FEATURE_FLAGS 启用 WhatsApp 聊天入口（懒加载 UI），并提供轻量主题配置（CSS 变量注入）。所有变更保持默认配置与现状一致，并补齐关键测试与文档。"
    },
    {
      "id": "c968f2a7-79db-496d-8dbf-22b046d13c3f",
      "name": "实现 WhatsApp 悬浮按钮并在 Layout 受控注入",
      "description": "新建组件 WhatsAppFloatingButton（支持 href=wa.me/号码），按 FEATURE_FLAGS.ENABLE_WHATSAPP_CHAT 与 SITE_CONFIG.contact.whatsappNumber 渲染；在 layout.tsx 条件注入，支持懒加载。",
      "notes": "不依赖服务端 API，仅前端入口。",
      "status": "COMPLETE",
      "dependencies": [
        {
          "taskId": "7130a40c-e626-4314-a965-c760d6cde23e"
        }
      ],
      "createdAt": "2025-11-12T09:12:01.205Z",
      "updatedAt": "2025-11-12T14:41:04.563259Z",
      "relatedFiles": [
        {
          "path": "src/components/integrations/whatsapp-button.tsx",
          "type": "CREATE",
          "description": "悬浮按钮组件"
        },
        {
          "path": "src/app/[locale]/layout.tsx",
          "type": "TO_MODIFY",
          "description": "条件渲染按钮"
        }
      ],
      "implementationGuide": "pseudocode:\n- 新建组件读取 flag 与 number，有效则渲染 fixed 位置按钮，aria-label 完整\n- 在 layout.tsx 懒加载并条件渲染，靠近 Footer 放置\n- 链接示例: https://wa.me/<number>",
      "verificationCriteria": "开关打开且号码存在时显示按钮并可跳转；关闭时不渲染；懒加载不影响首屏。",
      "analysisResult": "以配置优先贯穿 UI 与服务端：新增联系表单配置模块（类型、默认值、Zod 配置校验与动态 Schema 生成器），让基础必填字段可配置，同时维持现有 ContactFormContainer 与服务端处理链。扩展 FEATURE_FLAGS 启用 WhatsApp 聊天入口（懒加载 UI），并提供轻量主题配置（CSS 变量注入）。所有变更保持默认配置与现状一致，并补齐关键测试与文档。"
    },
    {
      "id": "ba2f3385-5e38-45dc-a5eb-c220ff97c4c8",
      "name": "主题定制最小注入（单站点）",
      "description": "新增 src/config/theme-customization.ts 定义 brand/layout 及组件默认变体；在 layout 注入 CSS 变量；组件默认值在未显式指定时生效。",
      "notes": "轻量化，避免大改样式系统。",
      "status": "COMPLETE",
      "dependencies": [],
      "createdAt": "2025-11-12T09:12:01.205Z",
      "updatedAt": "2025-11-12T14:43:05.455799Z",
      "relatedFiles": [
        {
          "path": "src/config/theme-customization.ts",
          "type": "CREATE",
          "description": "主题配置"
        },
        {
          "path": "src/app/[locale]/layout.tsx",
          "type": "TO_MODIFY",
          "description": "注入 CSS 变量"
        }
      ],
      "implementationGuide": "pseudocode:\n- THEME_CUSTOMIZATION = brand(primary,secondary,accent), layout(maxContentWidth, headerStyle), components(button defaultVariant/defaultSize)\n- layout.tsx 注入 :root CSS 变量或全局样式\n- 仅提供默认 fallback，不改变组件 API",
      "verificationCriteria": "变更配置后主色等变量生效；未配置时维持现状；无明显性能回退。",
      "analysisResult": "以配置优先贯穿 UI 与服务端：新增联系表单配置模块（类型、默认值、Zod 配置校验与动态 Schema 生成器），让基础必填字段可配置，同时维持现有 ContactFormContainer 与服务端处理链。扩展 FEATURE_FLAGS 启用 WhatsApp 聊天入口（懒加载 UI），并提供轻量主题配置（CSS 变量注入）。所有变更保持默认配置与现状一致，并补齐关键测试与文档。"
    },
    {
      "id": "cecb847b-735c-4269-9303-f8715e85b36d",
      "name": "测试与文档：动态 Schema/配置驱动 UI/WhatsApp 开关",
      "description": "新增单元测试与文档：1) 动态 Schema 组合与邮箱白名单；2) ContactFormContainer 的 required/星号与启用/禁用；3) WhatsApp 按钮的 FeatureFlag 门控；4) 默认配置回归；更新 README/docs。",
      "notes": "不扩大测试范围；重点覆盖配置分支与回归。",
      "status": "COMPLETE",
      "dependencies": [
        {
          "taskId": "4c0218e5-4843-4e0a-8977-f4155dabe1d6"
        },
        {
          "taskId": "9e8c94a7-6ed7-43e3-abf3-5a9a6dab4d60"
        },
        {
          "taskId": "c968f2a7-79db-496d-8dbf-22b046d13c3f"
        }
      ],
      "createdAt": "2025-11-12T09:12:01.205Z",
      "updatedAt": "2025-11-12T14:55:05.641083Z",
      "relatedFiles": [
        {
          "path": "tests/contact-form/builder.test.ts",
          "type": "CREATE",
          "description": "动态 Schema 组合测试"
        },
        {
          "path": "src/components/forms/__tests__/contact-form-container.test.tsx",
          "type": "TO_MODIFY",
          "description": "增加配置驱动用例"
        },
        {
          "path": "src/components/integrations/__tests__/whatsapp-button.test.tsx",
          "type": "CREATE",
          "description": "开关门控"
        },
        {
          "path": "README.md",
          "type": "TO_MODIFY",
          "description": "新增配置与使用说明"
        }
      ],
      "implementationGuide": "pseudocode:\n- builder.test: 覆盖 enabled/required/order、隐私复选框关闭策略、域白名单\n- contact-form-container.test: required 与星号切换、字段隐藏\n- whatsapp-button.test: flag 与号码门控\n- README: 配置字段、示例与常见问题",
      "verificationCriteria": "新增测试全部通过；默认配置下现有测试不回退；README 增加配置说明与示例。",
      "analysisResult": "以配置优先贯穿 UI 与服务端：新增联系表单配置模块（类型、默认值、Zod 配置校验与动态 Schema 生成器），让基础必填字段可配置，同时维持现有 ContactFormContainer 与服务端处理链。扩展 FEATURE_FLAGS 启用 WhatsApp 聊天入口（懒加载 UI），并提供轻量主题配置（CSS 变量注入）。所有变更保持默认配置与现状一致，并补齐关键测试与文档。"
    }
  ]
}
