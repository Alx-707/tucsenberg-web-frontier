# 项目技术栈

## 1. 核心框架

### 前端框架

- **Next.js 15.4.6** - React 全栈框架，App Router 架构 ✅ **已升级**
- **React 19.1.1** - 用户界面库，支持服务器组件 ✅ **已升级**
- **TypeScript 5.9.2** - 类型安全的 JavaScript 超集
- **Tailwind CSS 4.1.11** - 原子化 CSS 框架，CSS-first 配置

### 渲染策略

- **SSG + ISR** - 静态生成 + 增量静态再生，混合渲染模式
- **Server Actions** - 服务器端表单处理和数据变更
- **Edge Runtime（可选）** - 边缘计算支持

## 2. 内容管理

### TinaCMS + MDX 混合内容管理系统

#### TinaCMS 可视化编辑 ✅ **新增**

- **tinacms 2.7.7** - Git-based 内容管理系统，可视化编辑界面
- **@tinacms/cli 1.9.7** - TinaCMS 命令行工具，开发和构建支持
- **@tinacms/mdx 2.7.7** - MDX 文件的 TinaCMS 集成支持

#### MDX 核心支持

- **@next/mdx 15.4.6** - Next.js 原生 MDX 支持，App Router 兼容 ✅ **已升级**
- **@mdx-js/loader 3.1.0 & @mdx-js/react 3.1.0** - MDX 文件加载和 React 组件嵌入
- **gray-matter 4.0.3** - Frontmatter 解析库，YAML/JSON 元数据支持
- **@types/mdx 2.0.13** - MDX 类型定义

### 中间件和集成

- **import-in-the-middle 1.14.2** - 模块导入中间件，Sentry集成支持
- **require-in-the-middle 7.5.2** - 模块加载中间件，OpenTelemetry支持

### 内容目录结构

```
content/
├── posts/          # 博客文章
│   ├── en/        # 英文内容
│   └── zh/        # 中文内容
├── pages/          # 静态页面
├── documents/      # 文档文件 (PDF ≤20MB)
└── config/         # 全局配置
```

### 核心特性

#### TinaCMS 可视化编辑特性 ✅ **新增**

- **所见即所得编辑** - 实时预览，直观的内容编辑体验
- **Git 工作流集成** - 自动提交到 Git，版本控制和协作支持
- **多语言内容管理** - 统一界面管理英中双语内容
- **类型安全 Schema** - TypeScript 类型定义，确保数据完整性
- **团队协作支持** - 权限管理，编辑冲突预防机制

#### 传统 MDX 特性

- **Git-based 工作流** - 版本控制集成，内容变更触发自动部署
- **多语言同步** - 强制同步更新，确保内容一致性
- **类型安全验证** - TypeScript 接口确保数据完整性
- **无数据库架构** - 简化部署流程

### TinaCMS 集成配置 ✅ **新增**

#### 配置文件结构

```typescript
// tina/config.ts - TinaCMS 核心配置
{
  branch: 'main',                    // Git 分支
  clientId: process.env.TINA_CLIENT_ID,
  token: process.env.TINA_TOKEN,

  collections: [
    {
      name: 'posts',                 // 博客文章集合
      path: 'content/posts',
      format: 'mdx',
      fields: [/* 字段定义 */]
    },
    {
      name: 'pages',                 // 页面集合
      path: 'content/pages',
      format: 'mdx',
      fields: [/* 字段定义 */]
    }
  ]
}
```

#### 多语言支持策略

- **统一管理模式** - 单一界面管理英中双语内容
- **语言标识字段** - `locale` 字段区分语言版本
- **文件路径映射** - 自动映射到对应语言目录
- **同步更新机制** - 确保双语内容一致性

#### 开发工作流

```bash
# 开发环境启动
pnpm tina:dev              # TinaCMS + Next.js 开发服务器

# 访问地址
http://localhost:3000      # 主站
http://localhost:3000/admin # TinaCMS 管理界面
http://localhost:4001/graphql # GraphQL API
```

#### 生产部署配置

- **环境变量** - `TINA_CLIENT_ID`, `TINA_TOKEN`, `TINA_BRANCH`
- **构建集成** - `pnpm tina:build` 生成类型和客户端
- **Git 集成** - 自动提交内容变更到版本控制
- **Vercel 部署** - 无缝集成 Vercel 部署流程

### 数据管理服务

- **Airtable 0.12.2** - 云端表格数据库，联系表单数据存储和管理
  - API集成、Web界面、协作功能、数据导出、视图管理、自动化集成

### 通信服务

- **Resend 4.7.0** - 现代邮件发送服务

## 3. UI 设计系统

### 组件库

- **shadcn/ui (New York 风格)** - 现代化UI组件库，RSC 支持
- **@radix-ui/react-\*** - 无障碍组件primitives，包含以下核心组件：
  - **@radix-ui/react-dialog 1.1.14** - 模态对话框组件
  - **@radix-ui/react-dropdown-menu 2.1.15** - 下拉菜单组件
  - **@radix-ui/react-label 2.1.7** - 表单标签组件
  - **@radix-ui/react-navigation-menu 1.2.13** - 导航菜单组件
  - **@radix-ui/react-slot 1.2.3** - 组件插槽系统
  - **@radix-ui/react-tabs 1.1.12** - 标签页组件
- **class-variance-authority 0.7.1** - 组件样式变体管理
- **clsx 2.1.1 + tailwind-merge 3.3.1** - 条件类名和样式合并
- **lucide-react 0.533.0** - 现代图标库，SVG 图标组件
- **sonner 2.0.6** - 现代化通知系统
- **embla-carousel-react 8.6.0** - 高性能轮播组件
- **@bprogress/next** - 现代化页面加载进度条，TypeScript 重写版本

### 字体与排版

- **@tailwindcss/typography 0.5.16** - 企业级排版系统
- **next/font + geist 1.4.2** - Vercel官方字体优化
- **苹果中文字体系统** - PingFang SC原生系统字体
- **中英文混排优化** - 智能字体回退策略

### 主题与动画

- **next-themes 0.4.6** - 主题切换（系统/明亮/暗黑）
- **Tailwind CSS 动画** - 主要动画解决方案 ✅ **性能优先**
  - 企业级动画系统：accordion-down/up, fade-in, slide-in-from-top/bottom
  - CSS 原生动画，性能最佳，包体积最小
  - **tailwindcss-animate 1.0.7** - Tailwind CSS 动画扩展
  - **tw-animate-css 1.3.6** - 额外的 Tailwind CSS 动画工具
- **framer-motion 12.23.9** - 复杂动画备用方案 ✅ **按需使用**
  - 仅在 Tailwind CSS 动画不足时使用
  - 适用场景：复杂交互动画、页面转场
- **CSS 变量主题系统** - 动态主题切换

### 表单与验证

- **React Hook Form 7.61.1** - 高性能表单库
- **Zod 4.0.10** - TypeScript 优先的模式验证
- **botid** - Vercel BotID 无感知机器人防护

## 4. 开发工具链

### 代码质量

- **eslint 9.32.0** - 代码质量检查，Flat Config 配置方式
- **typescript-eslint 8.39.0** - TypeScript 专用规则 ✅ **已升级**
- **eslint-plugin-react 7.37.5** - React 组件规则
- **eslint-plugin-react-hooks 5.2.0** - React Hooks 最佳实践 ✅ **已升级**
- **eslint-plugin-react-you-might-not-need-an-effect 0.4.1** -
  useEffect 最佳实践检测
- **@next/eslint-plugin-next 15.4.6** - Next.js 专用规则 ✅ **已升级**
- **eslint-plugin-import 2.32.0** - 导入语句规则 ✅ **已升级**
- **eslint-plugin-promise 7.2.1** - Promise 最佳实践 ✅ **已升级**
- **eslint-config-prettier 10.1.8** - Prettier 冲突解决 ✅ **已升级**
- **eslint-plugin-security 3.0.1** - 安全规则检查
- **eslint-plugin-security-node 1.1.4** - Node.js 安全规则

#### ESLint 配置支持

- **@eslint/eslintrc 3.3.1** - ESLint 配置兼容层，支持 Flat Config 迁移
- **@eslint/js 9.32.0** - ESLint JavaScript 核心规则集

#### 企业级代码复杂度标准

- **complexity**: 最大复杂度15（错误级别），适合企业级业务逻辑
- **max-depth**: 最大嵌套深度4（错误级别），确保代码可读性
- **max-lines-per-function**: 最大函数行数120（错误级别），适应完整业务逻辑
- **max-params**: 最大参数数量5（错误级别），合理限制
- **max-statements**: 最大语句数30（错误级别），函数复杂度控制
- **max-lines**: 文件最大行数500（错误级别），模块大小控制

#### 测试文件特殊规则

- **测试文件复杂度标准**: 适当放宽但保持质量
  - **max-lines-per-function**: 最大1000行（适应大型测试套件）
  - **complexity**: 最大复杂度20（允许复杂的测试逻辑）
  - **max-nested-callbacks**: 最大6层嵌套（describe/it嵌套结构）
  - **max-params**: 最大8个参数（测试用例参数）
  - **max-statements**: 最大60个语句（测试断言）
- **安全标准**: 测试文件中安全规则绝不放宽，保持error级别

### 代码格式化

- **prettier 3.6.2** - 代码格式化核心
- **@ianvs/prettier-plugin-sort-imports 4.5.1** - 导入排序自动化 ✅ **已升级**
  - 从 @trivago/prettier-plugin-sort-imports 迁移，修复注释重复问题
  - 更好的注释处理和 TypeScript 支持
  - 与 prettier-plugin-tailwindcss 完美兼容
- **prettier-plugin-tailwindcss 0.6.8** - Tailwind CSS 类名排序

### 构建工具

- **@next/bundle-analyzer 15.4.6** - 包大小分析 ✅ **已升级**
- **开发环境构建** - Turbopack (`next dev --turbo`) 极速开发体验
- **生产环境构建** - Webpack 5 + SWC 编译器，稳定可靠的生产构建
- **pnpm 10.13.1** - 现代高性能包管理器，硬链接技术节省空间
- **size-limit 11.2.0** - 包大小监控和限制
- **dependency-cruiser 16.8.0** - 依赖关系分析和架构验证
- **madge 8.0.0** - 循环依赖检测
- **jscpd 4.0.5** - 代码重复度检测
- **@jscpd/badge-reporter 4.0.1** - 代码重复度徽章生成
- **@jscpd/html-reporter 4.0.1** - 代码重复度HTML报告
- **@size-limit/preset-big-lib 11.2.0** - 大型库包大小限制预设
- **glob 11.0.3** - 文件匹配和搜索工具

#### CSS 处理工具

- **@tailwindcss/postcss 4.1.11** - Tailwind CSS PostCSS 插件

#### 构建策略说明

- **开发模式**：使用 Turbopack 获得极速热重载和构建性能
- **生产模式**：使用成熟的 Webpack 5 确保构建稳定性和兼容性
- **编译器**：统一使用 SWC 编译器，提供最佳性能

### Git 工作流

- **lefthook 1.12.2** - Git hooks 管理 ✅ **已升级**
- **@commitlint/cli 19.8.1** - 提交信息规范
- **@commitlint/config-conventional 19.8.1** - 约定式提交
- **husky 9.1.7** - Git hooks 备用方案

### TypeScript 类型定义

- **@types/node 20.19.9** - Node.js 环境类型定义
- **@types/react 19.1.8** - React 19 类型定义
- **@types/react-dom 19.1.6** - React DOM 类型定义

### 配置文件清单

- **eslint.config.mjs** - ESLint 9 Flat Config 配置文件
- **.prettierrc.json** - Prettier 代码格式化配置
- **components.json** - shadcn/ui 组件库配置
- **next.config.ts** - Next.js 配置文件（集成 next-intl）
- **tsconfig.json** - TypeScript 配置文件
- **tailwind.config.js** - Tailwind CSS 配置文件
- **vitest.config.ts** - Vitest 测试配置文件
- **.size-limit.js** - 包大小限制配置文件
- **lefthook.yml** - Git hooks 配置文件
- **semgrep.yml** - 安全扫描规则配置
- **.npmrc** - pnpm 包管理器配置
- **.vscode/settings.json** - VS Code 开发环境配置

## 5. 性能优化

### 缓存策略

- **Next.js 内置缓存** - 框架原生缓存机制
- **Git-based 静态生成** - 内容变更触发自动重新构建
- **ISR 配置** - 静态生成 + 增量更新
- **Vercel Edge Cache** - 平台原生 CDN 缓存

### 监控与分析

- **@vercel/analytics 1.5.0** - 性能分析和用户行为追踪
- **web-vitals 5.0.3** - 核心性能指标监控
- **Google Analytics 4** - 详细的用户行为分析
- **错误边界增强** - React Error Boundaries + 基础错误报告

## 6. 安全部署

### 安全防护

- **botid** - Vercel BotID 无感知机器人防护，表单提交和关键交互防护
- **Next.js 安全头配置** - 内置安全头设置 (X-Frame-Options, CSP)
- **Next.js Middleware** - 中间件层面的安全防护

### 环境配置

- **@t3-oss/env-nextjs 0.13.8** - 类型安全的环境变量

### 日志记录与监控

- **@sentry/nextjs 9.44.2** - 错误监控和性能追踪，生产环境错误收集
- **@sentry/cli 2.50.2** - Sentry 命令行工具，构建时集成和源码映射上传
- **Vercel 函数日志** - 服务端监控，API 路由和 Server Actions 性能追踪
- **基础错误日志** - 简单的console.error收集，适合企业官网需求

## 7. 国际化与SEO

### 国际化

- **next-intl 4.3.4** - Next.js 国际化框架 ✅ **已升级** (4.0.0 → 4.3.4)
- **Lingo.dev 0.109.0** - AI 驱动的翻译服务
- **支持语言** - 英语(en) + 中文(zh)

### SEO 优化

- **Next.js 15 Metadata API** - 原生 SEO 优化解决方案
- **统一 metadata 工具函数** - 类型安全的 SEO 配置管理
- **多语言 SEO 支持** - 自动生成 alternates.languages 和本地化配置
- **next-sitemap 4.2.3** - 自动sitemap和hreflang生成
- **静态 OG 图片** - 预设计的社交媒体分享图片
- **结构化数据集成** - Schema.org JSON-LD 支持

### 企业通信

#### WhatsApp 集成方案

**🥇 推荐方案：官方 WhatsApp Business API**

- WhatsApp Business Platform API - Meta官方企业级API
- 2024年11月更新：无限免费服务对话，客户主动发起的对话完全免费
- 企业级功能：官方支持、完整分析报告、多媒体支持、交互式消息、CRM集成

## 8. 可选扩展

### 动画效果 ✅ **架构优化**

- **Tailwind CSS 动画** - 主要动画解决方案 ✅ **性能优先**
  - 企业级动画系统：accordion-down/up, fade-in, slide-in-from-top/bottom
  - CSS 原生动画，性能最佳，包体积最小
  - 通过 className 直接使用，开发效率高
  - 支持响应式和可访问性（motion-safe/motion-reduce）
- **framer-motion 12.23.9** - 复杂动画备用方案 ✅ **按需使用**
  - 仅在 Tailwind CSS 动画不足时使用
  - 适用场景：复杂交互动画、页面转场、布局动画
  - 内置 useInView hook 处理高级滚动触发动画
  - 混合使用策略：简单动画用 Tailwind，复杂动画用 framer-motion
- **intersection-observer (原生API)** - 滚动监听基础方案
- **lucide-react 0.533.0** - 现代图标库，SVG 图标组件
- **lottie-react** - 复杂动画和品牌动画支持

### 媒体处理

- **sharp 0.34.3** - 高性能图片处理库，Next.js 图片优化后端 ✅ **已升级**
- **react-loading-skeleton** - 骨架屏加载状态
- **PDF文档处理** - 推荐使用下载链接方案

> **安全修复记录**：已移除 `imagemin-cli 8.0.0`（存在多个高危安全漏洞），推荐使用 sharp 进行图片处理

### 地图集成（可选）

- **react-leaflet 5.0.0** - 开源地图组件，适合多地点企业

## 9. 项目架构

### 核心目录结构

- **src/app/** - Next.js 15 App Router，国际化路由 `[locale]`
- **src/components/** - 组件库分层：`ui/`、`layout/`、`content/`、`shared/`
- **content/** - MDX 内容存储，多语言目录结构（详见第2章）
- **src/lib/** - 工具库：内容管理、国际化配置、文件处理
- **src/types/** - TypeScript 类型定义
- **messages/** - next-intl 国际化文件

### 设计系统规范

- **主题系统** - 三模式切换（Light/Dark/System），Vercel 风格简约设计
- **组件库** - shadcn/ui New York 风格 + 响应式导航 + 企业级页脚
- **字体系统** - Geist Sans + Geist Mono + 中文字体回退
- **命名规范** - 组件：PascalCase，文件：kebab-case，变量：camelCase

## 测试工具

### 核心测试框架

- **vitest 3.2.4** - 现代化测试框架，Vite 原生支持，替代 Jest ✅ **现代化升级**
- **@vitest/coverage-v8 3.2.4** - V8 引擎覆盖率工具，高性能代码覆盖率分析
- **@vitest/ui 3.2.4** - Vitest 可视化测试界面，实时测试监控
- **jsdom 26.1.0** - JSDOM 测试环境，模拟浏览器环境
- **@testing-library/react 16.3.0** - React 组件测试，用户行为驱动测试
- **@testing-library/jest-dom 6.6.4** - DOM 断言扩展，兼容 Vitest
- **@testing-library/user-event 14.6.1** - 用户交互事件模拟

### 无障碍性和性能测试

- **@axe-core/playwright 4.10.2** - Playwright 无障碍性测试集成
- **axe-core 4.10.3** - 无障碍性测试核心引擎
- **@lhci/cli 0.15.1** - Lighthouse CI 自动化性能监控 ✅ **已升级**
- **lighthouse 12.8.1** - 性能和质量审计工具 ✅ **已升级**

### 代码分析工具

- **@babel/parser 7.28.0** - Babel AST 解析器，用于代码分析
- **@babel/traverse 7.28.0** - AST 遍历工具，代码转换支持

> **现代化升级记录**：从 `jest 29.7.0` 迁移到 `vitest 3.2.4`，获得更好的 TypeScript 支持、更快的测试执行速度和原生 ESM 支持
> **安全修复记录**：已移除 `lighthouse-ci 1.13.1`（存在安全漏洞），保留独立的 `lighthouse` 工具和 `@lhci/cli` 作为替代

### WhatsApp 功能测试覆盖

- **API 客户端测试** - WhatsApp API 客户端库完整测试
- **API 路由测试** - 消息发送和 Webhook 处理测试
- **组件测试** - WhatsApp 联系组件和浮动按钮测试
- **E2E 集成测试** - 完整用户流程端到端测试
- **响应式测试** - 移动端、平板、桌面端适配测试
- **无障碍测试** - 键盘导航和 ARIA 标签测试

## 配置最佳实践

### 核心配置验证 ✅

- **中间件配置** - 国际化路由 + 静态资源排除
- **图片优化** - WebP/AVIF 支持 + 缓存策略
- **缓存策略** - SSG/ISR 混合渲染，Git-based 内容更新
- **技术栈兼容性** - Next.js 15 + React 19 + TypeScript 5.9 + Tailwind CSS 4

#### 性能优化建议

- **开发模式**：启用 `next dev --turbo` 获得极速开发体验
- **生产构建**：使用稳定的 Webpack 5 + SWC 编译器组合
- **缓存策略**：合理配置 ISR 和静态生成
- **图片优化**：自动使用 sharp，支持现代格式

#### 代码质量最佳实践

- **Prettier 插件迁移**：从 @trivago/prettier-plugin-sort-imports 迁移到 @ianvs/prettier-plugin-sort-imports
  - 解决了 JSDoc 注释重复问题
  - 改进的 TypeScript 和 React 支持
  - 更稳定的导入排序算法
  - 配置兼容性：支持 importOrder、importOrderParserPlugins 等核心配置

#### 依赖版本管理最佳实践

- **版本同步策略**：保持文档与 package.json 实际版本一致
  - 定期执行 `pnpm outdated` 检查可升级依赖
  - 优先升级安全补丁和小版本更新
  - 重大版本升级前进行充分测试
  - 升级后立即更新技术栈文档
- **质量验证流程**：每次依赖升级后执行完整质量检查
  - 类型检查：`pnpm type-check`
  - 代码检查：`pnpm lint:check`
  - 格式检查：`pnpm format:check`
  - 安全审计：`pnpm audit --audit-level moderate`

#### 安全最佳实践

- **CSP 头部**：配置严格的内容安全策略
- **Server Actions**：使用不可猜测的安全 ID
- **环境变量**：使用 @t3-oss/env-nextjs 验证
- **依赖安全**：定期运行 `pnpm audit` 检查 ✅ **已修复所有漏洞**
- **botid 集成**：表单保护和机器人检测

#### 安全漏洞修复记录 ✅ **2025-01-05 完成**

**已移除的有漏洞工具**：
- `broken-link-checker 0.7.8` - 移除原因：
  - Critical: form-data 不安全随机函数漏洞
  - High: robots-txt-guard 正则表达式拒绝服务漏洞
  - High: semver 正则表达式拒绝服务漏洞
  - Moderate: request SSRF 漏洞、tough-cookie 原型污染、useragent ReDoS 漏洞

- `imagemin-cli 8.0.0` - 移除原因：
  - High: semver-regex ReDoS、trim-newlines 资源消耗、http-cache-semantics ReDoS、cross-spawn ReDoS 漏洞
  - Moderate: got 重定向到 UNIX socket 漏洞
  - **替代方案**：使用 `sharp 0.34.3` 进行图片处理

- `lighthouse-ci 1.13.1` - 移除原因：
  - High: lodash.set 原型污染漏洞
  - Moderate: got 重定向漏洞
  - **替代方案**：保留 `lighthouse 12.8.1` 和 `@lhci/cli 0.15.1`

**修复验证**：
- 安全审计：`pnpm audit --audit-level moderate` ✅ 通过
- 质量检查：`pnpm quality:check` ✅ 通过
- 项目稳定性：所有功能正常运行 ✅ 确认
