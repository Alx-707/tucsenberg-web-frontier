name: æ·±åº¦å®‰å…¨æ‰«æ

# ============================================================================
# èŒè´£ï¼šæ·±åº¦å®‰å…¨æ‰«æï¼ˆSemgrep full scanï¼‰
# è§¦å‘ï¼šä»…åœ¨ main åˆ†æ”¯æ¨é€æˆ–å®šæ—¶ä»»åŠ¡è¿è¡Œï¼Œä¸é˜»å¡ PR
# ä¾èµ–ï¼šåŸºç¡€è´¨é‡æ£€æŸ¥ç”± ci.yml è´Ÿè´£
# ============================================================================

on:
  push:
    branches: [main]
  schedule:
    # æ¯æ—¥ UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰æ‰§è¡Œæ·±åº¦æ‰«æ
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  semgrep-full-scan:
    name: Semgrep æ·±åº¦å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false
          persist-credentials: false

      - name: å®‰è£… Semgrep CLI
        run: |
          python3 -m pip install --user "semgrep<2"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Semgrep å®Œæ•´å®‰å…¨æ‰«æ
        run: |
          set -euo pipefail
          echo "ğŸ” Running Semgrep full security scan..."

          # ERROR çº§è§„åˆ™ï¼šç¡¬é—¨ç¦
          semgrep scan \
            --config semgrep.yml \
            --severity ERROR \
            --error \
            --sarif --sarif-output semgrep-error.sarif \
            src/

          # WARNING çº§è§„åˆ™ï¼šä»…è®°å½•ï¼Œä¸é˜»å¡
          semgrep scan \
            --config semgrep.yml \
            --severity WARNING \
            --sarif --sarif-output semgrep-warning.sarif \
            src/ || true

          echo "âœ… Semgrep scan completed"

      - name: ä¸Šä¼  SARIF åˆ° GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-error.sarif
          category: semgrep-security
        continue-on-error: true

      - name: ä¸Šä¼ æ‰«ææŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: |
            semgrep-error.sarif
            semgrep-warning.sarif
          retention-days: 30
          if-no-files-found: ignore

  scan-summary:
    name: æ‰«ææ€»ç»“
    runs-on: ubuntu-latest
    needs: [semgrep-full-scan]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ç”Ÿæˆæ‰«ææ€»ç»“
        run: |
          echo "## ğŸ”’ æ·±åº¦å®‰å…¨æ‰«ææ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Semgrep æ‰«æ**: ${{ needs.semgrep-full-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: åŸºç¡€è´¨é‡æ£€æŸ¥ï¼ˆtype-check, lint, testï¼‰ç”± ci.yml ç»Ÿä¸€å¤„ç†" >> $GITHUB_STEP_SUMMARY
          echo "> PR çº§åˆ«çš„ Semgrep baseline æ‰«æå·²ç§»è‡³ ci.yml" >> $GITHUB_STEP_SUMMARY
