name: Vercel éƒ¨ç½²å¢žå¼º

# æ­¤ workflow ä½œä¸º Vercel GitHub é›†æˆçš„è¡¥å……
# ä¸»è¦ç”¨äºŽéƒ¨ç½²å‰çš„é¢å¤–è´¨é‡æ£€æŸ¥å’Œéƒ¨ç½²åŽçš„éªŒè¯

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # éƒ¨ç½²å‰è´¨é‡æ£€æŸ¥
  pre-deployment-checks:
    name: éƒ¨ç½²å‰è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ç±»åž‹æ£€æŸ¥
        run: pnpm type-check

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: pnpm lint:check

      - name: æž„å»ºéªŒè¯
        run: pnpm build:check

      - name: ç¿»è¯‘éªŒè¯
        run: pnpm validate:translations

      - name: è´¨é‡é—¨ç¦
        run: pnpm quality:gate

  # ç­‰å¾… Vercel éƒ¨ç½²å®Œæˆ
  wait-for-vercel:
    name: ç­‰å¾… Vercel éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    timeout-minutes: 10
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: ç­‰å¾… Vercel éƒ¨ç½²
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.1
        id: wait-for-vercel
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 600
          check_interval: 10

      - name: è¾“å‡ºéƒ¨ç½² URL
        run: |
          echo "éƒ¨ç½² URL: ${{ steps.wait-for-vercel.outputs.url }}"
          echo "VERCEL_DEPLOYMENT_URL=${{ steps.wait-for-vercel.outputs.url }}" >> $GITHUB_ENV

  # éƒ¨ç½²åŽéªŒè¯ (ä»…åœ¨æœ‰éƒ¨ç½² URL æ—¶è¿è¡Œ)
  post-deployment-verification:
    name: éƒ¨ç½²åŽéªŒè¯
    runs-on: ubuntu-latest
    needs: wait-for-vercel
    timeout-minutes: 10
    if: success()

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯éƒ¨ç½²å¥åº·çŠ¶æ€
        run: |
          DEPLOYMENT_URL="${{ needs.wait-for-vercel.outputs.url }}"
          
          # æ£€æŸ¥æ ¹è·¯å¾„
          echo "æ£€æŸ¥æ ¹è·¯å¾„..."
          curl -f -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL" || exit 1
          
          # æ£€æŸ¥è‹±æ–‡è·¯ç”±
          echo "æ£€æŸ¥è‹±æ–‡è·¯ç”±..."
          curl -f -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/en" || exit 1
          
          # æ£€æŸ¥ä¸­æ–‡è·¯ç”±
          echo "æ£€æŸ¥ä¸­æ–‡è·¯ç”±..."
          curl -f -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/zh" || exit 1
          
          echo "âœ… æ‰€æœ‰è·¯ç”±éªŒè¯é€šè¿‡"

      - name: éªŒè¯ API ç«¯ç‚¹
        run: |
          DEPLOYMENT_URL="${{ needs.wait-for-vercel.outputs.url }}"
          
          # æ£€æŸ¥ robots.txt
          echo "æ£€æŸ¥ robots.txt..."
          curl -f -s "$DEPLOYMENT_URL/robots.txt" | grep -q "User-agent" || exit 1
          
          # æ£€æŸ¥ sitemap.xml
          echo "æ£€æŸ¥ sitemap.xml..."
          curl -f -s "$DEPLOYMENT_URL/sitemap.xml" | grep -q "urlset" || exit 1
          
          echo "âœ… API ç«¯ç‚¹éªŒè¯é€šè¿‡"

  # éƒ¨ç½²æ€»ç»“
  deployment-summary:
    name: éƒ¨ç½²æ€»ç»“
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, wait-for-vercel, post-deployment-verification]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ç”Ÿæˆéƒ¨ç½²æ€»ç»“
        run: |
          echo "## ðŸš€ Vercel éƒ¨ç½²æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½² URL**: ${{ needs.wait-for-vercel.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.pre-deployment-checks.result }}" == "success" ] && \
             [ "${{ needs.wait-for-vercel.result }}" == "success" ] && \
             [ "${{ needs.post-deployment-verification.result }}" == "success" ]; then
            echo "âœ… **çŠ¶æ€**: éƒ¨ç½²æˆåŠŸå¹¶é€šè¿‡æ‰€æœ‰éªŒè¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **çŠ¶æ€**: éƒ¨ç½²å¤±è´¥æˆ–éªŒè¯æœªé€šè¿‡" >> $GITHUB_STEP_SUMMARY
          fi

