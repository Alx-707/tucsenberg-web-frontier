name: Vercel éƒ¨ç½²å¢žå¼º

# æ­¤ workflow ä½œä¸º Vercå°” GitHub é›†æˆçš„è¡¥å……
# ä¸»è¦ç”¨äºŽéƒ¨ç½²å‰çš„é¢å¤–è´¨é‡æ£€æŸ¥å’Œéƒ¨ç½²åŽçš„éªŒè¯

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.sha }}
  cancel-in-progress: true

jobs:
  # éƒ¨ç½²å‰è´¨é‡æ£€æŸ¥
  pre-deployment-checks:
    name: éƒ¨ç½²å‰è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ç±»åž‹æ£€æŸ¥
        run: pnpm type-check

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: pnpm lint:check

      - name: æž„å»ºéªŒè¯
        run: pnpm build:check

      - name: ç¿»è¯‘éªŒè¯
        run: pnpm validate:translations

      - name: è´¨é‡é—¨ç¦
        run: pnpm quality:gate

  # åŸºäºŽ Token çš„ Vercel éƒ¨ç½²
  deploy-to-vercel:
    name: éƒ¨ç½²åˆ° Vercelï¼ˆtokenï¼‰
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    timeout-minutes: 15
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    outputs:
      preview_url: ${{ steps.vercel_cli_deploy.outputs.deployment-url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ç¡®ä¿å…ˆå®‰è£… pnpmï¼Œå†å¯ç”¨ setup-node çš„ pnpm ç¼“å­˜ï¼Œé¿å…ç¼“å­˜é˜¶æ®µæ‰¾ä¸åˆ° pnpm
      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1
          run_install: false
          standalone: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£… Vercel CLI
        run: npm i -g vercel@latest
        env:
          CI: true

      - name: æ‹‰å– Vercel çŽ¯å¢ƒé…ç½® (preview)
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: ä½¿ç”¨ Vercel CLI æž„å»º
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: é€šè¿‡ Token éƒ¨ç½²é¢„æž„å»ºäº§ç‰©
        id: vercel_cli_deploy
        run: |
          set -euo pipefail
          DEPLOY_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment-url=${DEPLOY_URL}" >> "$GITHUB_OUTPUT"
          echo "VERCEL_DEPLOYMENT_URL=${DEPLOY_URL}" >> "$GITHUB_ENV"
          echo "éƒ¨ç½² URL: ${DEPLOY_URL}"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: è°ƒè¯•è¾“å‡ºéƒ¨ç½² URLï¼ˆæ‘˜è¦ï¼‰
        if: always()
        run: |
          echo "preview_url=${{ steps.vercel_cli_deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "preview_url=${{ steps.vercel_cli_deploy.outputs.deployment-url }}"

  # éƒ¨ç½²åŽéªŒè¯ (ä»…åœ¨æœ‰éƒ¨ç½² URL æ—¶è¿è¡Œ)
  post-deployment-verification:
    name: éƒ¨ç½²åŽéªŒè¯
    runs-on: ubuntu-latest
    needs: deploy-to-vercel
    timeout-minutes: 15
    if: needs.deploy-to-vercel.outputs.preview_url != ''

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç­‰å¾…éƒ¨ç½²å°±ç»ªï¼ˆå¢žå¼ºç‰ˆï¼‰
        run: |
          set -euo pipefail
          url="${{ needs.deploy-to-vercel.outputs.preview_url }}"
          echo "ç­‰å¾…éƒ¨ç½²å°±ç»ª: $url"

          max_tries=60       # æœ€é•¿ 60 æ¬¡æŽ¢æµ‹
          delay=5            # åˆå§‹ç­‰å¾… 5 ç§’

          for i in $(seq 1 $max_tries); do
            # å…ˆ HEADï¼ˆæ›´è½»é‡ï¼‰ï¼Œå¤±è´¥å† GET
            status=$(curl -s -o /dev/null -w "%{http_code}" -I "$url" || echo "000")
            if [ "$status" = "000" ]; then
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            fi

            echo "ç¬¬ $i æ¬¡æŽ¢æµ‹: $status"
            if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
              echo "éƒ¨ç½²å·²å°±ç»ª"
              exit 0
            fi

            # å¯¹å¸¸è§å†·å¯åŠ¨/ä¼ æ’­ä¸­çš„çŠ¶æ€åšé€€é¿
            case "$status" in
              000|404|425|429|500|502|503|504)
                ;;
              *)
                ;;
            esac

            # æ¯ 10 æ¬¡åŠ å¤§ç­‰å¾… 5 ç§’ï¼Œä¸Šé™ 20 ç§’
            if [ $((i % 10)) -eq 0 ] && [ "$delay" -lt 20 ]; then
              delay=$((delay + 5))
            fi
            sleep "$delay"
          done
          echo "ç­‰å¾…è¶…æ—¶ï¼Œéƒ¨ç½²æœªå°±ç»ª" >&2
          exit 1

      - name: éªŒè¯éƒ¨ç½²å¥åº·çŠ¶æ€
        run: |
          DEPLOYMENT_URL="${{ needs.deploy-to-vercel.outputs.preview_url }}"

          # æ£€æŸ¥æ ¹è·¯å¾„
          echo "æ£€æŸ¥æ ¹è·¯å¾„..."
          curl -f -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL" || exit 1

          # æ£€æŸ¥è‹±æ–‡è·¯ç”±
          echo "æ£€æŸ¥è‹±æ–‡è·¯ç”±..."
          curl -f -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/en" || exit 1

          # æ£€æŸ¥ä¸­æ–‡è·¯ç”±
          echo "æ£€æŸ¥ä¸­æ–‡è·¯ç”±..."
          curl -f -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/zh" || exit 1

          echo "âœ… æ‰€æœ‰è·¯ç”±éªŒè¯é€šè¿‡"

      - name: éªŒè¯ API ç«¯ç‚¹
        run: |
          DEPLOYMENT_URL="${{ needs.deploy-to-vercel.outputs.preview_url }}"

          # æ£€æŸ¥ robots.txt
          echo "æ£€æŸ¥ robots.txt..."
          curl -f -s "$DEPLOYMENT_URL/robots.txt" | grep -q "User-agent" || exit 1

          # æ£€æŸ¥ sitemap.xml
          echo "æ£€æŸ¥ sitemap.xml..."
          curl -f -s "$DEPLOYMENT_URL/sitemap.xml" | grep -q "urlset" || exit 1

          echo "âœ… API ç«¯ç‚¹éªŒè¯é€šè¿‡"

  # éƒ¨ç½²æ€»ç»“
  deployment-summary:
    name: éƒ¨ç½²æ€»ç»“
    runs-on: ubuntu-latest
    needs:
      [pre-deployment-checks, deploy-to-vercel, post-deployment-verification]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ç”Ÿæˆéƒ¨ç½²æ€»ç»“
        run: |
          echo "## ðŸš€ Vercel éƒ¨ç½²æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½² URL**: ${{ needs.deploy-to-vercel.outputs.preview_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.pre-deployment-checks.conclusion }}" == "success" ] && \
             [ "${{ needs.deploy-to-vercel.conclusion }}" == "success" ] && \
             [ "${{ needs.post-deployment-verification.conclusion }}" == "success" ]; then
            echo "âœ… **çŠ¶æ€**: éƒ¨ç½²æˆåŠŸå¹¶é€šè¿‡æ‰€æœ‰éªŒè¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **çŠ¶æ€**: éƒ¨ç½²å¤±è´¥æˆ–éªŒè¯æœªé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "- éƒ¨ç½²å‰æ£€æŸ¥: ${{ needs.pre-deployment-checks.conclusion }}" >> $GITHUB_STEP_SUMMARY
            echo "- Vercel éƒ¨ç½²: ${{ needs.deploy-to-vercel.conclusion }}" >> $GITHUB_STEP_SUMMARY
            echo "- éƒ¨ç½²åŽéªŒè¯: ${{ needs.post-deployment-verification.conclusion }}" >> $GITHUB_STEP_SUMMARY
          fi
