name: Performance Check

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'public/**'
      - 'next.config.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.size-limit.js'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'next.config.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.size-limit.js'
  workflow_dispatch:
    inputs:
      save_baseline:
        description: 'Save performance baseline'
        required: false
        default: 'false'
        type: boolean

jobs:
  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm type-check

      - name: Lint check
        run: pnpm lint

      - name: Build project
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Cache performance baseline
        uses: actions/cache@v3
        with:
          path: reports/performance-baseline.json
          key: performance-baseline-${{ github.ref_name }}
          restore-keys: |
            performance-baseline-main
            performance-baseline-

      - name: Run performance analysis (PR)
        if: github.event_name == 'pull_request'
        run: |
          node scripts/performance-analyzer.js --compare-baseline --ci
        env:
          CI: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERFORMANCE_WEBHOOK_URL: ${{ secrets.PERFORMANCE_WEBHOOK_URL }}

      - name: Run performance analysis (Push to main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          node scripts/performance-analyzer.js --save-baseline --compare-baseline --ci
        env:
          CI: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERFORMANCE_WEBHOOK_URL: ${{ secrets.PERFORMANCE_WEBHOOK_URL }}

      - name: Run performance analysis (Manual with baseline)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.save_baseline == 'true'
        run: |
          node scripts/performance-analyzer.js --save-baseline --compare-baseline --ci
        env:
          CI: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERFORMANCE_WEBHOOK_URL: ${{ secrets.PERFORMANCE_WEBHOOK_URL }}

      - name: Run performance analysis (Manual)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.save_baseline == 'false'
        run: |
          node scripts/performance-analyzer.js --compare-baseline --ci
        env:
          CI: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERFORMANCE_WEBHOOK_URL: ${{ secrets.PERFORMANCE_WEBHOOK_URL }}

      - name: Upload performance reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-reports
          path: |
            reports/performance-report.json
            reports/performance-baseline.json
          retention-days: 30

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const reportPath = path.join(process.cwd(), 'reports', 'performance-report.json');
              if (!fs.existsSync(reportPath)) {
                console.log('Performance report not found');
                return;
              }
              
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              let comment = '## ðŸ“Š æ€§èƒ½åˆ†æžæŠ¥å‘Š\n\n';
              comment += `**æ€§èƒ½å¾—åˆ†:** ${report.performance.score}/100\n`;
              comment += `**çŠ¶æ€:** ${report.passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n`;
              comment += `**åˆ†æ”¯:** ${context.payload.pull_request.head.ref}\n`;
              comment += `**æäº¤:** ${context.payload.pull_request.head.sha.substring(0, 8)}\n\n`;
              
              // åŒ…å¤§å°åˆ†æž
              comment += '### ðŸ“¦ åŒ…å¤§å°åˆ†æž\n';
              comment += '| ç±»åž‹ | å¤§å° | çŠ¶æ€ |\n';
              comment += '|------|------|------|\n';
              
              const bundleSize = report.performance.bundleSize;
              const limits = {
                main: 50 * 1024,
                framework: 130 * 1024,
                shared: 220 * 1024
              };
              
              Object.entries(bundleSize).forEach(([type, size]) => {
                const limit = limits[type];
                const status = limit && size > limit ? 'ðŸ”´ è¶…é™' : 'ðŸŸ¢ æ­£å¸¸';
                const sizeStr = (size / 1024).toFixed(1) + 'KB';
                comment += `| ${type} | ${sizeStr} | ${status} |\n`;
              });
              
              // å›žå½’æ£€æµ‹
              if (report.regression && report.regression.detected) {
                comment += '\n### ðŸš¨ æ€§èƒ½å›žå½’\n';
                report.regression.details.forEach(regression => {
                  const icon = regression.severity === 'critical' ? 'ðŸ”´' : 
                              regression.severity === 'high' ? 'ðŸŸ ' : 'ðŸŸ¡';
                  comment += `- ${icon} **${regression.metric}:** ${regression.change} (${regression.current} vs ${regression.baseline})\n`;
                });
              }
              
              // é—®é¢˜åˆ—è¡¨
              if (report.issues && report.issues.length > 0) {
                comment += '\n### ðŸš¨ å‘çŽ°çš„é—®é¢˜\n';
                report.issues.forEach((issue, index) => {
                  const icon = issue.severity === 'high' ? 'ðŸ”´' : 
                              issue.severity === 'medium' ? 'ðŸŸ¡' : 'ðŸŸ¢';
                  comment += `${index + 1}. ${icon} ${issue.message}\n`;
                });
              }
              
              comment += '\n---\n';
              comment += '*æ€§èƒ½åˆ†æžç”± [Performance Analyzer](https://github.com/actions) è‡ªåŠ¨ç”Ÿæˆ*';
              
              // æŸ¥æ‰¾çŽ°æœ‰è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
              });
              
              const existingComment = comments.find(comment => 
                comment.body.includes('ðŸ“Š æ€§èƒ½åˆ†æžæŠ¥å‘Š')
              );
              
              if (existingComment) {
                // æ›´æ–°çŽ°æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: comment
                });
              }
              
            } catch (error) {
              console.error('Error creating performance comment:', error);
            }

  size-limit-check:
    name: Size Limit Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Check bundle size
        run: pnpm size:check

      - name: Analyze bundle size (if failed)
        if: failure()
        run: |
          echo "Bundle size check failed. Analyzing..."
          pnpm size:why || true
          pnpm analyze || true

  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Start server
        run: |
          pnpm start &
          sleep 10
        env:
          PORT: 3000

      - name: Run Lighthouse audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: '.lighthouserc.js'
          uploadArtifacts: true
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [performance-analysis, size-limit-check]
    if: always()

    steps:
      - name: Download performance reports
        uses: actions/download-artifact@v3
        with:
          name: performance-reports
          path: reports/

      - name: Generate performance summary
        run: |
          echo "## ðŸŽ¯ æ€§èƒ½æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.performance-analysis.result }}" == "success" ]; then
            echo "âœ… **æ€§èƒ½åˆ†æž:** é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ€§èƒ½åˆ†æž:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.size-limit-check.result }}" == "success" ]; then
            echo "âœ… **åŒ…å¤§å°æ£€æŸ¥:** é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **åŒ…å¤§å°æ£€æŸ¥:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹å„ä¸ªä½œä¸šçš„è¾“å‡ºå’Œä¸Šä¼ çš„æž„ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY
