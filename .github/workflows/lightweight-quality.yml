name: è½»é‡çº§è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lightweight-quality:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # éœ€è¦è·å–å‰ä¸€ä¸ªæäº¤ç”¨äºdiff

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œè½»é‡çº§è´¨é‡æ£€æŸ¥
        run: pnpm quality:quick:verbose

      - name: è¿è¡Œæ€§èƒ½åˆ†æ
        run: pnpm analyze:performance
        continue-on-error: true

      - name: ç”Ÿæˆå®Œæ•´è´¨é‡æŠ¥å‘Š
        run: pnpm quality:report
        continue-on-error: true

      - name: éƒ¨ç½²å‰æ£€æŸ¥ï¼ˆä»…ä¸»åˆ†æ”¯ï¼‰
        if: github.ref == 'refs/heads/main'
        run: pnpm deploy:check
        continue-on-error: true

      - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            reports/quick-quality-report.json
            reports/simple-quality-report.json
            reports/simple-quality-report.html
          retention-days: 30

      - name: è¯„è®ºPRï¼ˆå¦‚æœæ˜¯PRï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './reports/simple-quality-report.json';

            if (fs.existsSync(path)) {
              const report = JSON.parse(fs.readFileSync(path, 'utf8'));
              const score = report.summary.overallScore;
              const passed = report.summary.passedChecks;
              const total = report.summary.totalChecks;

              let comment = '## ğŸ” è½»é‡çº§è´¨é‡æ£€æŸ¥æŠ¥å‘Š\n\n';
              comment += `**æ€»ä½“åˆ†æ•°**: ${score}/100\n`;
              comment += `**æ£€æŸ¥ç»“æœ**: ${passed}/${total} é€šè¿‡\n\n`;
              comment += '### ğŸ“Š é¡¹ç›®ç»Ÿè®¡\n';
              comment += `- **æºæ–‡ä»¶**: ${report.stats.totalFiles} ä¸ª\n`;
              comment += `- **ä»£ç è¡Œæ•°**: ${report.stats.codeLines} è¡Œ\n`;
              comment += `- **æµ‹è¯•è¦†ç›–**: ${report.stats.testCoverage}%\n\n`;
              comment += '### âœ… æ£€æŸ¥è¯¦æƒ…\n';

              report.checks.forEach(check => {
                const icon = check.status === 'PASS' ? 'âœ…' : 'âŒ';
                comment += `- ${icon} ${check.name}\n`;
              });

              if (report.recommendations.length > 0) {
                comment += '\n### ğŸ’¡ æ”¹è¿›å»ºè®®\n';
                report.recommendations.forEach((rec, i) => {
                  comment += `${i+1}. **[${rec.priority}]** ${rec.title}: ${rec.description}\n`;
                });
              }

              comment += '\n---\n*æ­¤æŠ¥å‘Šç”±è½»é‡çº§è´¨é‡æ£€æŸ¥ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
