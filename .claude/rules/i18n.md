---
paths: "messages/**/*.json, src/i18n/**/*"
---

# Internationalization (i18n)

## Framework

- **Library**: next-intl
- **Locales**: `en` (English), `zh` (Chinese)
- **Default**: `en`

## Translation Files

```
messages/
├── en/
│   ├── critical.json    # Above-the-fold, SEO-critical
│   └── deferred.json    # Below-the-fold, lazy-loaded
├── zh/
│   ├── critical.json
│   └── deferred.json
├── en.json              # Vitest mocks (merged from critical + deferred)
└── zh.json              # Vitest mocks (merged from critical + deferred)
```

### Critical vs Deferred
- **critical.json**: Navigation, header, footer, SEO metadata, error messages
- **deferred.json**: Page-specific content (about, products, blog, etc.)

## Using Translations

### In Server Components
```typescript
import { getTranslations } from 'next-intl/server';

export default async function Page() {
  // Locale auto-detected from i18n/request.ts config
  const t = await getTranslations('products');

  return <h1>{t('pageTitle')}</h1>;
}

// For generateMetadata or special cases, pass locale explicitly:
export async function generateMetadata({ params }: PageProps) {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: 'products' });
  return { title: t('pageTitle') };
}
```

### In Client Components
```typescript
'use client';
import { useTranslations } from 'next-intl';

export function ProductCard() {
  const t = useTranslations('products.card');
  return <span>{t('moq')}</span>;
}
```

### Client Provider Setup

Client Components require `NextIntlClientProvider` in layout:

```typescript
// app/[locale]/layout.tsx
import { NextIntlClientProvider } from 'next-intl';
import { loadCriticalMessages } from '@/lib/load-messages';

export default async function LocaleLayout({ children, params }) {
  const { locale } = await params;
  // Performance optimization: only load critical messages for client
  const messages = await loadCriticalMessages(locale);

  return (
    <NextIntlClientProvider locale={locale} messages={messages}>
      {children}
    </NextIntlClientProvider>
  );
}
```

**Note**: This project uses `loadCriticalMessages()` instead of `getMessages()` to minimize client bundle size by loading only critical translations.

## Advanced Usage

### Rich Text & Markup
```typescript
// With React components
t.rich('message', {
  bold: (chunks) => <strong>{chunks}</strong>,
});

// With HTML (use carefully)
t.markup('message', {
  bold: (chunks) => `<strong>${chunks}</strong>`,
});
```

### Check Key Existence
```typescript
if (t.has('someKey')) {
  // Translation exists
}
```

### Other Server APIs
```typescript
import { getMessages, getLocale, getFormatter } from 'next-intl/server';

const messages = await getMessages();
const locale = await getLocale();
const format = await getFormatter();
```

## Adding New Translations

1. Add keys to both `en/` and `zh/` files
2. Keep structure identical across locales
3. Run `pnpm validate:translations` to validate sync (or `pnpm i18n:full` for comprehensive check)
4. Use nested keys for organization: `namespace.section.key`

## Namespace Rules

- Namespace keys **cannot contain `.`** (dot is used for nesting)
- Use camelCase or kebab-case for naming

## Key Files

| File | Purpose |
|------|---------|
| `src/i18n/request.ts` | Message loading (critical + deferred) |
| `src/i18n/routing.ts` | Locale config, pathnames |
| `src/lib/load-messages.ts` | Message loader utilities |

## Cache Components Compatibility

### Required: `setRequestLocale`

**Must call `setRequestLocale(locale)` in `[locale]/layout.tsx`** to ensure next-intl works correctly with Cache Components:

```typescript
// src/app/[locale]/layout.tsx
import { setRequestLocale } from 'next-intl/server';

export default async function LocaleLayout({ children, params }) {
  const { locale } = await params;
  setRequestLocale(locale); // Required for Cache Components
  // ...
}
```

### Forbidden: Request-dependent APIs in `"use cache"`

**Never use these APIs inside `"use cache"` functions**:
- `getTranslations()` (without explicit locale)
- `getLocale()`
- `getMessages()` (without explicit locale)

These APIs depend on request context and will fail in cached segments.

```typescript
// ❌ Error: request-dependent API in cached segment
async function getCachedContent() {
  'use cache';
  const t = await getTranslations('home'); // Implicitly reads request
}

// ✅ Correct: use explicit locale parameter
async function getCachedContent(locale: 'en' | 'zh') {
  'use cache';
  cacheLife('days');
  const t = await getTranslations({ locale, namespace: 'home' });
}
```

### Safe APIs for `"use cache"`

| API | Safe in Cache | Notes |
|-----|---------------|-------|
| `getTranslations({ locale, namespace })` | ✅ | Explicit locale |
| `loadCriticalMessages(locale)` | ✅ | Explicit locale |
| `getTranslations()` (no args) | ❌ | Reads request |
| `getLocale()` | ❌ | Reads request |
| `getMessages()` | ❌ | Reads request |

**See also**: `docs/known-issue/cache-components-plan.md` for detailed compatibility guide.
